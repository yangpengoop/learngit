<?php
namespace app\admin\controller;
use think\Controller;
use app\admin\model\AdminUser;
use think\Config;
class Login extends controller
{
    public function index()
    {
        return $this->fetch('showLogin');
    }

    /**
     * 用户登录
     * @param password username
     * @return json
     * @author zhanghanwen
     */
    public function sub_login(){
        $password = trim(strip_tags(input('password')));
        $username = trim(strip_tags(input('username')));
        // 检测输入参数
        $this->checkParam();
        // 加密盐
        $salt = Config::get('security.salt');
        // 用户表控制器
        $adminUserModel = new AdminUser();
        // 用户名密码检测
        $uid = $adminUserModel->checkUser($username,md5($password.$salt));
        if($uid){
            session("user_id",$uid);
            die(json_encode(['status'=>true,'msg'=>'登录成功！','redirect_url'=>url('admin/index/dashboard')]));
        } else{
            die(json_encode(['status'=>false,'msg'=>'用户名或密码错误！']));
        }
    }

    /**
     * 检测输入参数
     * @param code username password
     * @return json
     * @author zhanghanwen
     */
    private function checkParam(){
        $captcha = trim(strip_tags(input('code')));
        $username = trim(strip_tags(input('username')));
        $password = trim(strip_tags(input('password')));
        // 检测用户名是否为空
        if(!$username){
            die(json_encode(['status'=>false,'msg'=>'请输入用户名！']));
        }
        // 检测密码是否为空
        if(!$password){
            die(json_encode(['status'=>false,'msg'=>'请输入密码！']));
        }
        // 检测验证码
        /*if(!captcha_check($captcha)){
            //验证码错误
            die(json_encode(['status'=>false,'msg'=>'验证码错误！']));
        }
          */
    }

    /**
     * 登出操作
     *
     */
    public function log_out(){
        session('user_id',0);
        $this->redirect('Login/index');
    }
}
